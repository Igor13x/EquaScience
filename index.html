<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <title>EquaScience</title>
</head>

<body>
    <header class="container-fluid py-3" id="all">
        <div class="row py-4 d-flex align-items-center">
            <a class="col-12">
                <img src="img/EquaScience.png" class="img-fluid imglogo" alt="Logo EquaScience">
            </a>
            <div class="col-4 d-flex justify-content-end position-absolute end-0 align-items-center">
                <button onclick="logoutUser()" id="botaoVoltar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" class="bi bi-x-square-fill" viewBox="0 0 16 16">
                    <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm3.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708"/>
                  </svg>
                  <h5 class="d-none d-sm-block">Logout</h5>
                </button>
            </div>
        </div>
    </header>

    <div class="container mt-5 px-3 px-sm-0" id="login-container">
        <div class="row d-flex justify-content-center">
            <div class="card py-4 px-md-5 px-4 shadow-lg col-xl-10 col-lg-11 col-md-12" style="border-radius: 10px;">
                <h3 class="text-center my-2 mb-4">Bem-vindo ao EquaScience!</h3>
                <input type="email" id="email" class="form-control mb-2 px-4 py-2" placeholder="Email" required>
                <input type="password" id="password" class="form-control mb-2 px-4 py-2" placeholder="Senha" required>
                <div class="row d-flex justify-content-center flex-row align-items-center mt-3 mb-5">
                    <div class="d-block col-11 col-sm-6 col-md-4 mb-2 mb-sm-0">
                        <button onclick="loginUser()" class="btn btn-primary w-100 py-3"><b>Login</b></button>
                    </div>
                    <div class="d-block col-11 col-sm-6 col-md-4">
                        <button onclick="registerUser()" class="btn btn-outline-primary w-100 py-3"><b>Cadastrar</b></button>    
                    </div>
                </div>
            </div>    
        </div>
        
    </div>

    <div class="container mt-5 pb-5" id="content-container" style="display: none;">
        <div class="row">
            <div class="col-12">
                <h1 id="titlo" class="text-center mb-4">Seja Bem-Vindo ao EquaScience!</h1>
                <p class="mx-3" style="text-align: justify;">
                    Este é um site dedicado a criar, calcular e gerenciar fórmulas científicas de maneira fácil e prática. Você pode adicionar elementos às fórmulas e até mesmo calcular o resultado com base nos valores que definir.
                </p>
                <li class="mb-3 ps-4">
                    <b>O que fazer a seguir?</b>
                </li>
                <p class="mx-3" style="text-align: justify;">
                    Fórmulas Pré-prontas: O EquaScience oferece uma coleção de fórmulas científicas pré-prontas, que você pode utilizar como desejar. Elas estão disponíveis para você editar, adaptar ou simplesmente calcular os resultados com base nos valores que fornecer.
                </p>
                <p class="mx-3" style="text-align: justify;">
                    Criar uma Fórmula: Clique em "Criar Fórmula" e forneça um nome, descrição, categoria e a expressão matemática que deseja utilizar. Você também pode adicionar elementos à fórmula, definindo identificadores, descrições, valores e se são constantes.
                </p>
                <p class="mx-3" style="text-align: justify;">
                    Adicionar Elementos: Selecione "Adicionar Elemento" para incluir variáveis, constantes e seus respectivos valores na fórmula.
                </p>
                <p class="mx-3" style="text-align: justify;">
                    Salvar e Calcular: Após preencher tudo, clique em "Salvar Fórmula". Você pode, então, calcular o resultado da fórmula a qualquer momento, e também editar ou excluir as fórmulas que já criou.
                </p>
            </div>
        </div>
    </div>

    <div class="container" id="forms">
        <div class="formula-container pb-4">
            <h2 class="ps-3 py-2">Criar Fórmula</h2>
            <div class="form-group mb-1">
                <input type="text" id="formula-name" class="form-control mb-2 px-4 py-2" placeholder="Nome da fórmula" />
            </div>
            <div class="form-group mb-1">
                <input type="text" id="formula-desc" class="form-control mb-2 px-4 py-2" placeholder="Descrição" />
            </div>
            <div class="form-group mb-1">
                <input type="text" id="formula-category" class="form-control mb-2 px-4 py-2" placeholder="Categoria" />
            </div>
            <div class="form-group mb-1">
                <input type="text" id="formula-expression" class="form-control mb-2 px-4 py-2" placeholder="Expressão (ex: g + 5 = u)" />
            </div>

            <div id="elementos-container" class="mb-1">
                <!-- Elementos adicionados aqui -->
            </div>

            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-primary mx-1" id="add-element-btn">
                    <i class="bi bi-plus-circle"></i> Adicionar Elemento
                </button>
                <button class="btn btn-outline-success mx-1" id="save-formula-btn">Salvar Fórmula</button>
                <button class="btn btn-outline-danger mx-1" id="cancel-edit-btn" style="display: none;">Cancelar</button>

            </div>
        </div>
    </div>

    <div class="container" id="results">
        <div id="result-container" class="my-3">
            <h3 class="ps-3 py-2">Resultado da Fórmula:</h3>
            <div id="calculation-result"></div>
        </div>

        <div class="formula-list">
            <h2 id="formula-list-title" class="ps-3 py-2 pb-3">Fórmulas Salvas</h2>
            <ul id="formula-list" class="list-group">
                <!-- Fórmulas salvas serão listadas aqui -->
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getDatabase, ref, push, set, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyAV4ufNzH_l-o7YWueyzccFirjSpCXaBEw",
    authDomain: "equascience-5653d.firebaseapp.com",
    databaseURL: "https://equascience-5653d-default-rtdb.firebaseio.com",
    projectId: "equascience-5653d",
    storageBucket: "equascience-5653d.appspot.com",
    messagingSenderId: "495646348438",
    appId: "1:495646348438:web:23dbe97f4adf6fcfbc5eb7",
    measurementId: "G-BBCPLPH301",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const database = getDatabase(app);

let formulaIdBeingEdited = null;  // Declaração global da variável
let currentUserId = 'defaultUser';  // Define o "defaultUser" como padrão até que o usuário faça login
let isEditingPublicFormula = false; // Determina se a fórmula sendo editada é pública


const setUserRole = (userId, role) => {
  const db = getDatabase();
  const userRef = ref(db, 'users/' + userId);
  set(userRef, {
    role: role,  // Define o papel como 'admin' ou 'user'
  });
};


// Ouve mudanças no estado de autenticação
// Ouve mudanças no estado de autenticação
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUserId = user.uid;  // O ID do usuário logado é armazenado
        console.log("Usuário logado com UID:", currentUserId);
        loadFormulas(user.uid);  // Carrega as fórmulas após login
        loadPublicFormulas();
        
        // Se o usuário for anônimo ou o 'defaultUser', não esconde o login ainda
        if (user.isAnonymous || user.uid === 'defaultUser') {
            showLoginScreen();  // Garante que a tela de login permaneça visível
        } else {
            showContentAfterLogin();  // Mostra o conteúdo após login
        }
    } else {
        currentUserId = 'defaultUser';  // Se não houver usuário, é o defaultUser
        hideContentUntilLoggedIn();  // Garante que a tela de login seja visível
    }
});

// Funções para controlar a visibilidade das telas
window.hideContentUntilLoggedIn = function() {
    document.getElementById('content-container').style.display = 'none';
    document.getElementById('login-container').style.display = 'block';  // Garante que o login esteja visível
};

window.showContentAfterLogin = function() {
    document.getElementById('content-container').style.display = 'block';
    document.getElementById('forms').style.display = 'block';  // Exibe o formulário de criação de fórmula
    document.getElementById('results').style.display = 'block';  // Exibe o container de resultados

    const loginContainer = document.getElementById('login-container');
    if (loginContainer) {
        loginContainer.style.display = 'none';  // Esconde o login-container
    }
};

// Função para verificar o estado do login
window.checkUserLoginStatus = function() {
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Se o usuário for anônimo ou o 'defaultUser', mantém a tela de login visível
            if (user.isAnonymous || user.uid === 'defaultUser') {
                console.log("Usuário anônimo ou defaultUser, mantendo tela de login.");
                showLoginScreen();  // Garante que a tela de login permaneça visível
            } else {
                hideLoginScreen();  // Esconde a tela de login
                showContentAfterLogin();  // Mostra o conteúdo principal
            }
        } else {
            // Se não houver usuário logado, mostra a tela de login
            console.log("Nenhum usuário logado.");
            showLoginScreen();
        }
    });
};

// Função para esconder o conteúdo até o login
window.hideLoginScreen = function() {
    document.getElementById('login-container').classList.add('logged-in');
    document.getElementById('login-container').style.display = 'none';  // Esconde o cartão de login
};

// Função para mostrar a tela de login
window.showLoginScreen = function() {
    document.getElementById('login-container').classList.remove('logged-in');
    document.getElementById('login-container').style.display = 'block';  // Mostra o cartão de login
};


// Verifica o estado do login ao carregar a página
window.addEventListener('load', async function() {
    await authenticateDefaultUser();  // Garante que o defaultUser está autenticado
    window.checkUserLoginStatus();   // Verifica o estado de login do usuário
});

// Função para autenticar o defaultUser


// Função de login de usuário
// Torne loginUser globalmente acessível
function validateEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
}

// Torne loginUser globalmente acessível
window.loginUser = loginUser;


async function loginUser() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    if (!email || !password) {
        alert('Por favor, preencha todos os campos.');
        return;
    }

    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log("Usuário logado:", user.uid);
        loadFormulas(user.uid);  // Carrega as fórmulas após login
    } catch (error) {
        console.error("Erro ao fazer login:", error.message);
        alert('Erro ao fazer login: ' + error.message);
    }
}

// Função de registro de usuário
window.registerUser = async function() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        console.log('Usuário cadastrado:', userCredential.user);
        showContentAfterLogin(); // Exibe o conteúdo após o cadastro
    } catch (error) {
        console.error('Erro ao cadastrar:', error);
        alert('Erro ao cadastrar: ' + error.message);
    }
};

// Função de logout de usuário
window.logoutUser = async function() {
    try {
        await signOut(auth);
        console.log('Usuário deslogado');
        hideContentUntilLoggedIn(); // Exibe a tela de login após o logout
    } catch (error) {
        console.error('Erro ao fazer logout:', error);
        alert('Erro ao fazer logout: ' + error.message);
    }
};

async function setItem(formula) {
  const salvarformula = {
    nome: formula.nome,
    desc: formula.desc,
    categoria: formula.categoria,
    expressao: formula.expressao,
    elementos: formula.elementos.map((el) => ({
      identificador: el.identificador,
      desc: el.desc,
      isConstante: el.isConstante || false,
      valor: el.valor || null,
    })),
  };

  try {
    const user = auth.currentUser;
    if (!user) {
      throw new Error('Usuário não autenticado');
    }

    const userFormulasPath = `users/${user.uid}/formulas`;

    if (formulaIdBeingEdited) {
      // Atualiza fórmula existente
      await update(ref(database, `${userFormulasPath}/${formulaIdBeingEdited}`), salvarformula);
      console.log('Fórmula editada com sucesso!');
    } else {
      // Cria uma nova fórmula
      const formulaRef = push(ref(database, userFormulasPath));
      await set(formulaRef, salvarformula);
      console.log('Fórmula salva com sucesso!');
    }

    loadFormulas(); // Atualiza a lista de fórmulas
    resetForm();    // Reseta o formulário
  } catch (error) {
    console.error('Erro ao salvar fórmula:', error);
    alert('Erro ao salvar fórmula.');
  }
}

// Função para salvar fórmula no banco de dados
async function saveFormula() {
    const nome = document.getElementById('formula-name').value;
    const desc = document.getElementById('formula-desc').value;
    const categoria = document.getElementById('formula-category').value;
    const expressao = document.getElementById('formula-expression').value;

    const formulaElementos = {};
    const elementos = document.querySelectorAll('#elementos-container .input-group');

    elementos.forEach((elem, index) => {
        const identificador = elem.querySelector('input[id$="-id"]').value;
        const descricao = elem.querySelector('input[id$="-desc"]').value;
        const isConstante = elem.querySelector('input[id$="-is-constant"]').checked;
        const valor = parseFloat(elem.querySelector('input[id$="-value"]').value) || null;

        formulaElementos[`elem-${index}`] = {
            identificador,
            desc: descricao,
            isConstante,
            valor,
        };
    });

    const formula = {
        nome,
        desc,
        categoria,
        expressao,
        elementos: formulaElementos,
    };

    try {
        const user = auth.currentUser;

        // Verifica o usuário atual
        if (!user) {
            alert("Usuário não autenticado. Faça login para salvar fórmulas.");
            return;
        }

        let path;
        if (user.uid === 'defaultUser') {
            // Caminho para fórmulas públicas
            path = `formulas/public`;
        } else {
            // Caminho para fórmulas privadas
            path = `users/${user.uid}/formulas`;
        }

        // Salvar nova fórmula ou atualizar fórmula existente
        if (formulaIdBeingEdited) {
            await update(ref(database, `${path}/${formulaIdBeingEdited}`), formula);
            console.log('Fórmula atualizada com sucesso!');
        } else {
            const formulaRef = push(ref(database, path));
            await set(formulaRef, formula);
            console.log('Fórmula salva com sucesso!');
        }

        loadFormulas(); // Atualiza a lista de fórmulas
        resetForm();    // Reseta o formulário
    } catch (error) {
        console.error('Erro ao salvar fórmula:', error);
        alert('Erro ao salvar fórmula: ' + error.message);
    }
}

async function saveEditedFormula() {
    const nome = document.getElementById('formula-name').value;
    const desc = document.getElementById('formula-desc').value;
    const categoria = document.getElementById('formula-category').value;
    const expressao = document.getElementById('formula-expression').value;

    const formulaElementos = {};
    const elementos = document.querySelectorAll('#elementos-container .input-group');

    elementos.forEach((elem, index) => {
        const identificador = elem.querySelector('input[id$="-id"]').value;
        const descricao = elem.querySelector('input[id$="-desc"]').value;
        const isConstante = elem.querySelector('input[id$="-is-constant"]').checked;
        const valor = parseFloat(elem.querySelector('input[id$="-value"]').value) || null;

        formulaElementos[`elem-${index}`] = {
            identificador,
            desc: descricao,
            isConstante,
            valor,
        };
    });

    const formula = {
        nome,
        desc,
        categoria,
        expressao,
        elementos: formulaElementos,
    };

    try {
        const user = auth.currentUser; // Obtém o usuário atual

        if (!formulaIdBeingEdited) {
            alert('Nenhuma fórmula para salvar.');
            return;
        }

        if (isEditingPublicFormula) {
            // Salva no banco de dados público
            await update(ref(database, `formulas/public/${formulaIdBeingEdited}`), formula);
            console.log('Fórmula pública atualizada com sucesso!');
        } else if (user) {
            // Salva no banco de dados privado do usuário
            await update(ref(database, `users/${user.uid}/formulas/${formulaIdBeingEdited}`), formula);
            console.log('Fórmula privada atualizada com sucesso!');
        } else {
            alert('Erro: Não foi possível determinar o local de salvamento.');
        }

        // Recarregar fórmulas
        if (isEditingPublicFormula) {
            loadPublicFormulas(); // Recarrega fórmulas públicas
        } else {
            loadPrivateFormulas(); // Função para recarregar as fórmulas privadas
        }

        resetForm(); // Reseta o formulário de edição

    } catch (error) {
        console.error('Erro ao salvar fórmula:', error);
        alert('Erro ao salvar fórmula: ' + error.message);
    }
}


// Função para autenticar o defaultUser
async function authenticateDefaultUser() {
    try {
        const user = auth.currentUser;
        if (!user) {
            const result = await signInAnonymously(auth);
            currentUserId = result.user.uid;
            console.log('defaultUser autenticado com ID:', currentUserId);
        } else {
            currentUserId = user.uid;
            console.log('Usuário já autenticado com ID:', currentUserId);
        }
    } catch (error) {
        console.error('Erro ao autenticar defaultUser:', error);
    }
}

// Função para adicionar um novo elemento ao formulário
function createElementGroup(idPrefix, index = null, elem = {}) {
    const group = document.createElement('div');
    group.className = 'input-group mb-3';
    group.id = idPrefix + (index || Date.now());

    group.innerHTML = `
        <div class="input-group-prepend">
            <span class="input-group-text">Identificador</span>
        </div>
        <input type="text" class="form-control" placeholder="Identificador" id="${idPrefix}-id" value="${elem.identificador || ''}" />
        
        <div class="input-group-prepend">
            <span class="input-group-text">Descrição</span>
        </div>
        <input type="text" class="form-control" placeholder="Descrição" id="${idPrefix}-desc" value="${elem.desc || ''}" />

        <div class="input-group-prepend">
            <span class="input-group-text">Constante</span>
        </div>
        <input type="checkbox" class="form-check-input" id="${idPrefix}-is-constant" ${elem.isConstante ? 'checked' : ''} />

        <div class="input-group-prepend">
            <span class="input-group-text">Valor</span>
        </div>
        <input type="number" class="form-control" placeholder="Valor" id="${idPrefix}-value" value="${elem.valor || ''}" />

        <button type="button" class="btn btn-outline-danger" onclick="removeElemento('${group.id}')">
            <i class="bi bi-x-circle"></i> Remover
        </button>
    `;

    return group;
}



        // Função para adicionar elementos
        function addElemento() {
            const container = document.getElementById('elementos-container');
            const id = `elem-${Date.now()}`;

            const group = document.createElement('div');
            group.className = 'input-group mb-3';
            group.id = id;

            group.innerHTML = `
                <div class="input-group-prepend">
                    <span class="input-group-text">Identificador</span>
                </div>
                <input type="text" class="form-control" placeholder="Identificador (ex: g)" id="${id}-id" />
                
                <div class="input-group-prepend">
                    <span class="input-group-text">Descrição</span>
                </div>
                <input type="text" class="form-control" placeholder="Descrição" id="${id}-desc" />

                <div class="input-group-prepend">
                    <span class="input-group-text">Constante</span>
                </div>
                <input type="checkbox" class="form-check-input" id="${id}-is-constant" />

                <div class="input-group-prepend">
                    <span class="input-group-text">Valor</span>
                </div>
                <input type="number" class="form-control" placeholder="Valor" id="${id}-value" />
                
                <button type="button" class="btn btn-outline-danger" onclick="removeElemento('${id}')">
                    <i class="bi bi-x-circle"></i> Remover
                </button>
            `;

            container.appendChild(group);
        }

        window.removeElemento = function(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        };

        // Função para carregar fórmulas com escuta em tempo real
        // Função para carregar fórmulas com escuta em tempo real
async function loadFormulas() {
  try {
    const user = auth.currentUser;
    if (!user) {
      return;
    }

    // Carrega fórmulas públicas
    const publicSnapshot = await get(ref(database, 'formulas/public'));
    const publicFormulas = publicSnapshot.exists() ? publicSnapshot.val() : {};

    const list = document.getElementById('formula-list');
    list.innerHTML = '';  // Limpa a lista

    // Carrega fórmulas públicas
    if (publicFormulas && typeof publicFormulas === 'object') {
      Object.keys(publicFormulas).forEach(id => {
        const formula = publicFormulas[id];
        const li = document.createElement('li');
        li.classList.add('list-group-item', 'mb-3', 'p-3', 'border', 'rounded');

        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div id="salvas">
              <strong>${formula.nome}</strong> - ${formula.desc}<br>
              <small>Expressão: ${formula.expressao}</small><br>
              <small>Categoria: ${formula.categoria}</small>
            </div>
            <div class="d-flex justify-content-center align-itens-center flex-column">
                <button class="btn btn-outline-warning btn-sm" onclick="window.editFormula('${id}')">
                Editar
                </button>
            </div>
          </div>
        `;
        list.appendChild(li);
      });
    }

    // Carrega fórmulas privadas
    const privateSnapshot = await get(ref(database, `users/${user.uid}/formulas`));
    const privateFormulas = privateSnapshot.exists() ? privateSnapshot.val() : {};

    // Adiciona fórmulas privadas à lista
    if (privateFormulas && typeof privateFormulas === 'object') {
      Object.keys(privateFormulas).forEach(id => {
        const formula = privateFormulas[id];
        const li = document.createElement('li');
        li.classList.add('list-group-item', 'mb-3', 'p-3', 'border', 'rounded');

        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div id="salvas">
              <strong>${formula.nome}</strong> - ${formula.desc}<br>
              <small>Expressão: ${formula.expressao}</small><br>
              <small>Categoria: ${formula.categoria}</small>
            </div>
            <div class="d-flex justify-content-center align-itens-center flex-column">
                <button class="btn btn-outline-primary btn-sm mx-1 mb-1" onclick="window.calculateFormula('${id}')">
                Calcular
                </button>
                <button class="btn btn-outline-warning btn-sm mx-1 mb-1" onclick="window.editFormula('${id}')">
                Editar
                </button>
                <button class="btn btn-outline-danger btn-sm mx-1" onclick="window.deleteFormula('${id}')">
                Excluir
                </button>
            </div>
          </div>
        `;
        list.appendChild(li);
      });
    }
  } catch (error) {
    console.error('Erro ao carregar fórmulas:', error);
  }
}



// Função chamada quando o botão "Editar" é pressionado
function editFormula(formulaId) {
  formulaIdBeingEdited = formulaId;

  const user = auth.currentUser;
  if (!user) {
    alert('Você precisa estar logado para editar uma fórmula.');
    return;
  }

  // Carregar a fórmula do banco de dados
  const formulaRef = ref(database, `formulas/public/${formulaId}`); // Fórmulas públicas
  get(formulaRef).then((snapshot) => {
    if (snapshot.exists()) {
      const formula = snapshot.val();
      console.log('Fórmula carregada:', formula);  // Verificando a estrutura da fórmula

      // Preencher o formulário com os dados da fórmula
      document.getElementById('formula-nome').value = formula.nome;
      document.getElementById('formula-desc').value = formula.desc;
      document.getElementById('formula-categoria').value = formula.categoria;
      document.getElementById('formula-expressao').value = formula.expressao;

      // Verificando 'elementos' e assegurando que seja um objeto ou array
      let elementos = formula.elementos;
      console.log('elementos antes de processar:', elementos);

      // Se 'elementos' não for definido ou não for um array ou objeto, inicializa como array vazio
      if (!Array.isArray(elementos)) {
        if (typeof elementos !== 'object' || elementos === null) {
          console.log('Elemento não é um objeto ou array válido, inicializando como array vazio.');
          elementos = [];  // Inicializar como array vazio se não for um array válido
        } else {
          elementos = Object.entries(elementos);  // Caso seja um objeto, converte para array de chave/valor
        }
      }

      console.log('elementos após processamento:', elementos);  // Verificando a estrutura final de elementos

      // Iterar sobre o array de elementos
      elementos.forEach((el, index) => {
        console.log('Processando elemento:', el);
        document.getElementById(`elemento-${index}-identificador`).value = el.identificador || '';
        document.getElementById(`elemento-${index}-desc`).value = el.desc || '';
        document.getElementById(`elemento-${index}-valor`).value = el.valor || '';
      });

      // Mostrar o botão de salvar
      document.getElementById('salvar-formula').style.display = 'block';
    } else {
      alert('Fórmula não encontrada!');
    }
  }).catch((error) => {
    console.error('Erro ao carregar fórmula:', error);
    alert('Erro ao carregar fórmula para edição.');
  });
}

function salvarFormula() {
  const nome = document.getElementById('formula-nome').value;
  const desc = document.getElementById('formula-desc').value;
  const categoria = document.getElementById('formula-categoria').value;
  const expressao = document.getElementById('formula-expressao').value;
  
  // Carregar os elementos (se houver)
  const elementos = [];
  let index = 0;
  while (document.getElementById(`elemento-${index}-identificador`)) {
    const identificador = document.getElementById(`elemento-${index}-identificador`).value;
    const descElemento = document.getElementById(`elemento-${index}-desc`).value;
    const valor = document.getElementById(`elemento-${index}-valor`).value;

    if (identificador) {
      elementos.push({ identificador, desc: descElemento, valor });
    }

    index++;
  }

  // Objeto da fórmula
  const formulaAtualizada = {
    nome,
    desc,
    categoria,
    expressao,
    elementos
  };

  const formulaRef = ref(database, `formulas/public/${formulaIdBeingEdited}`); // Usando a ID da fórmula editada
  set(formulaRef, formulaAtualizada)  // Atualizar fórmula existente
    .then(() => {
      console.log('Fórmula salva com sucesso!');
      alert('Fórmula salva com sucesso!');
      // Atualize a interface para refletir as mudanças
      carregarFormulas(); // Função para recarregar as fórmulas
    })
    .catch((error) => {
      console.error('Erro ao salvar fórmula:', error);
      alert('Erro ao salvar fórmula!');
    });
}
// Função para calcular a fórmula
window.calculateFormula = async function (id) {
    try {
        const snapshot = await get(ref(database, 'users/' + auth.currentUser.uid + '/formulas/' + id));
        if (snapshot.exists()) {
            const formula = snapshot.val();
            const originalExpression = formula.expressao;
            let modifiedExpression = originalExpression;

            // Substituir variáveis pelos seus valores, mantendo o identificador caso não tenha valor
            if (formula.elementos) {
                Object.values(formula.elementos).forEach((elemento) => {
                    const regex = new RegExp(`\\b${elemento.identificador}\\b`, 'g');
                    const valor = (elemento.valor !== null && elemento.valor !== undefined) ? elemento.valor : elemento.identificador;
                    modifiedExpression = modifiedExpression.replace(regex, valor);
                });
            }

            // Avaliar a expressão matemática
            let result;
            try {
                // Extração apenas da parte matemática, caso contenha `=`
                let evalExpression = modifiedExpression;
                if (modifiedExpression.includes('=')) {
                    evalExpression = modifiedExpression.split('=')[1].trim();
                }

                result = eval(evalExpression); // Avalia a expressão matemática
            } catch (error) {
                result = 'Erro no cálculo';
            }

            // Exibe os resultados
            showCalculationResult(originalExpression, modifiedExpression, result);
        }
    } catch (error) {
        console.error('Erro ao calcular fórmula:', error);
    }
};
async function loadPublicFormulas() {
    try {
        const snapshot = await get(ref(database, 'formulas/public'));
        const formulas = snapshot.exists() ? snapshot.val() : {};

        const list = document.getElementById('formula-list');
        list.innerHTML = '';  // Limpa a lista

        if (formulas && typeof formulas === 'object') {
            Object.keys(formulas).forEach(id => {
                const formula = formulas[id];
                const li = document.createElement('li');
                li.classList.add('list-group-item', 'mb-3', 'p-3', 'border', 'rounded');

                li.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div id="salvas">
                            <strong>${formula.nome}</strong> - ${formula.desc}<br>
                            <small>Expressão: ${formula.expressao}</small><br>
                            <small>Categoria: ${formula.categoria}</small>
                        </div>
                        <div d-flex justify-content-center align-items-center flex-column>
                            <button class="btn btn-outline-warning btn-sm" onclick="window.editFormula('${id}')">
                                Editar
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar fórmulas públicas:', error);
    }
}



// Função para avaliar a expressão de maneira segura
function safeEval(expression) {
    try {
        return new Function('return ' + expression)();  // Usando uma função anônima para avaliar a expressão
    } catch (e) {
        return 'Erro no cálculo';
    }
}


      let isResultVisible = false;  // Controle de visibilidade do resultado

// Esta é a função que alterna a visibilidade do resultado
function showCalculationResult(original, modified, result) {
    const resultContainer = document.getElementById('calculation-result');
    
    // Limpar o conteúdo anterior da área de resultado
    resultContainer.innerHTML = '';
    
    // Verificar o estado e alternar visibilidade
    if (isResultVisible) {
        resultContainer.innerHTML = '';  // Se estiver visível, escondemos
        isResultVisible = false;  // Atualizamos o estado para oculto
    } else {
        resultContainer.innerHTML = `
            <h6 class="mx-2 mb-2" style="color=black"><strong>Expressão Original:</strong> ${original}</h6>
            <h6 class="mx-2 mb-2" style="color=black"><strong>Expressão Modificada:</strong> ${modified}</h6>
            <h6 class="mx-2 mb-2" style="color=black"><strong>Resultado:</strong> ${result}</h6>
        `;
        isResultVisible = true;  // Atualizamos o estado para visível
    }
}
window.editFormula = async function (formulaId) {
    try {
        const user = auth.currentUser; // Obtem o usuário atual
        let snapshot;

        // Verifica se a fórmula é pública
        snapshot = await get(ref(database, `formulas/public/${formulaId}`));
        if (!snapshot.exists() && user) {
            // Se não for pública, tenta carregar do espaço privado do usuário
            snapshot = await get(ref(database, `users/${user.uid}/formulas/${formulaId}`));
        }

        const formula = snapshot.val();

        if (!formula) {
            console.error('Fórmula não encontrada.');
            alert('Fórmula não encontrada.');
            return;
        }

        // Preenche os campos do formulário com os dados da fórmula
        document.getElementById('formula-name').value = formula.nome;
        document.getElementById('formula-desc').value = formula.desc;
        document.getElementById('formula-category').value = formula.categoria;
        document.getElementById('formula-expression').value = formula.expressao;

        // Reseta o container de elementos
        const elementosContainer = document.getElementById('elementos-container');
        elementosContainer.innerHTML = '';

        // Adiciona os elementos, se existirem
        if (formula.elementos && typeof formula.elementos === 'object') {
            Object.keys(formula.elementos).forEach((key) => {
                const elem = formula.elementos[key];
                const group = createElementGroup(key, null, elem);
                elementosContainer.appendChild(group);
            });
        }

        // Define o ID da fórmula que está sendo editada
        formulaIdBeingEdited = formulaId;

        // Define se a fórmula é pública ou privada (para salvamento posterior)
        isEditingPublicFormula = snapshot.key.startsWith('formulas/public');

    } catch (error) {
        console.error('Erro ao carregar fórmula para edição:', error);
        alert('Erro ao carregar fórmula para edição.');
    }
};




// Função para cancelar a edição
document.getElementById('cancel-edit-btn').addEventListener('click', function() {
    // Restaura o formulário para seu estado inicial
    resetForm();

    // Esconde o botão de "Cancelar"
    document.getElementById('cancel-edit-btn').style.display = 'none';
});

// Função para resetar o formulário
function resetForm() {
    formulaIdBeingEdited = null;
    document.getElementById('formula-name').value = '';
    document.getElementById('formula-desc').value = '';
    document.getElementById('formula-category').value = '';
    document.getElementById('formula-expression').value = '';
    document.getElementById('elementos-container').innerHTML = '';
}


        // Função para excluir a fórmula
        window.deleteFormula = async function(id) {
    const confirmation = confirm("Tem certeza de que deseja excluir esta fórmula?");
    if (confirmation) {
        try {
            const user = auth.currentUser;
            if (!user) {
                
                return;
            }

            // Caminho para a fórmula no Firebase
            const formulaRef = ref(database, 'users/' + user.uid + '/formulas/' + id);

            // Verifica se a fórmula realmente existe antes de tentar excluir
            const snapshot = await get(formulaRef);
            if (!snapshot.exists()) {
    console.error('A fórmula não existe.');
    alert('A fórmula que você está tentando excluir não existe.');
    return;
}

// Remove a fórmula
await remove(formulaRef);
console.log('Fórmula excluída com sucesso!');
alert('Fórmula excluída com sucesso!');
loadFormulas(user.uid);  // Atualiza a lista de fórmulas após exclusão
} catch (error) {
    console.error('Erro ao excluir a fórmula:', error);
    alert('Erro ao excluir a fórmula: ' + error.message);
}
};
};



        // Ações de clique para mostrar/ocultar
        document.getElementById("add-element-btn").addEventListener("click", addElemento);
        document.getElementById("save-formula-btn").addEventListener("click", saveFormula);

        loadFormulas(); // Carregar fórmulas salvas ao iniciar a página
    </script>
</body>

</html>