<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <title>EquaScience</title>
</head>

<body>
    <header class="container-fluid" id="all">
        <div class="row py-4 mb-2">
            <a>
                <img src="img/EquaScience.png" class="img-fluid imglogo" alt="Logo EquaScience">
            </a>
        </div>
    </header>

    <div class="container" id="dark-card">
        <div class="formula-container">
            <h2>Criar Fórmula</h2>
            <div class="form-group mb-1">
                <label for="formula-name"></label>
                <input type="text" id="formula-name" class="form-control" placeholder="Nome da fórmula" />
            </div>
            <div class="form-group mb-1">
                <label for="formula-desc"></label>
                <input type="text" id="formula-desc" class="form-control" placeholder="Descrição" />
            </div>
            <div class="form-group mb-1">
                <label for="formula-category"></label>
                <input type="text" id="formula-category" class="form-control" placeholder="Categoria" />
            </div>
            <div class="form-group mb-1">
                <label for="formula-expression"></label>
                <input type="text" id="formula-expression" class="form-control" placeholder="Expressão (ex: g + 5 = u)" />
            </div>

            <div id="elementos-container" class="mb-1">
                <!-- Elementos adicionados aqui -->
            </div>

            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-primary" id="add-element-btn">
                    <i class="bi bi-plus-circle"></i> Adicionar Elemento
                </button>
                <button class="btn btn-outline-success" id="save-formula-btn">Salvar Fórmula</button>
            </div>
        </div>
    </div>

    <div class="container" id="dark-card">
        <div id="result-container" class="my-4">
            <h3>Resultado da Fórmula:</h3>
            <div id="calculation-result"></div>
        </div>

        <div class="formula-list">
            <h2 id="formula-list-title">Fórmulas Salvas</h2>
            <ul id="formula-list" class="list-group">
                <!-- Fórmulas salvas serão listadas aqui -->
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, push, set, get, update, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAV4ufNzH_l-o7YWueyzccFirjSpCXaBEw",
            authDomain: "equascience-5653d.firebaseapp.com",
            databaseURL: "https://equascience-5653d-default-rtdb.firebaseio.com",
            projectId: "equascience-5653d",
            storageBucket: "equascience-5653d.appspot.com",
            messagingSenderId: "495646348438",
            appId: "1:495646348438:web:23dbe97f4adf6fcfbc5eb7",
            measurementId: "G-BBCPLPH301",
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let formulaIdBeingEdited = null;  // Variável para armazenar o ID da fórmula em edição

        // Função para salvar fórmula no banco de dados
        async function saveFormula() {
            const nome = document.getElementById('formula-name').value;
            const desc = document.getElementById('formula-desc').value;
            const categoria = document.getElementById('formula-category').value;
            const expressao = document.getElementById('formula-expression').value;

            const formulaElementos = {};
            const elementos = document.querySelectorAll('#elementos-container .input-group');

            elementos.forEach((elem, index) => {
                const identificador = elem.querySelector('input[id$="-id"]').value;
                const descricao = elem.querySelector('input[id$="-desc"]').value;
                const isConstante = elem.querySelector('input[id$="-is-constant"]').checked;
                const valor = parseFloat(elem.querySelector('input[id$="-value"]').value) || null;

                formulaElementos[`elem-${index}`] = {
                    identificador,
                    desc: descricao,
                    isConstante,
                    valor
                };
            });

            const formula = {
                nome,
                desc,
                categoria,
                expressao,
                elementos: formulaElementos
            };

            try {
                if (formulaIdBeingEdited) {
                    // Se estamos editando uma fórmula, usamos `update` para sobrescrever a fórmula existente
                    await update(ref(database, 'formulas/' + formulaIdBeingEdited), formula);
                    console.log('Fórmula editada com sucesso!');
                } else {
                    // Se não estivermos editando, criamos uma nova fórmula
                    const formulaRef = push(ref(database, 'formulas'));
                    await set(formulaRef, formula);
                    console.log('Fórmula salva com sucesso!');
                }

                loadFormulas();  // Atualiza a lista de fórmulas
                resetForm();  // Limpa o formulário e reseta o estado
            } catch (error) {
                console.log('Erro ao salvar fórmula:', error);
                alert('Erro ao salvar fórmula.');
            }
        }

        // Função para adicionar elementos
        function addElemento() {
            const container = document.getElementById('elementos-container');
            const id = `elem-${Date.now()}`;

            const group = document.createElement('div');
            group.className = 'input-group mb-3';
            group.id = id;

            group.innerHTML = `
                <div class="input-group-prepend">
                    <span class="input-group-text">Identificador</span>
                </div>
                <input type="text" class="form-control" placeholder="Identificador (ex: g)" id="${id}-id" />
                
                <div class="input-group-prepend">
                    <span class="input-group-text">Descrição</span>
                </div>
                <input type="text" class="form-control" placeholder="Descrição" id="${id}-desc" />

                <div class="input-group-prepend">
                    <span class="input-group-text">Constante</span>
                </div>
                <input type="checkbox" class="form-check-input" id="${id}-is-constant" />

                <div class="input-group-prepend">
                    <span class="input-group-text">Valor</span>
                </div>
                <input type="number" class="form-control" placeholder="Valor" id="${id}-value" />
                
                <button type="button" class="btn btn-outline-danger" onclick="removeElemento('${id}')">
                    <i class="bi bi-x-circle"></i> Remover
                </button>
            `;

            container.appendChild(group);
        }

        window.removeElemento = function(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        };

        // Carregar fórmulas salvas do banco de dados
        async function loadFormulas() {
            try {
                const snapshot = await get(ref(database, 'formulas'));
                if (snapshot.exists()) {
                    const formulas = snapshot.val();
                    const list = document.getElementById('formula-list');
                    list.innerHTML = '';  // Limpa a lista antes de atualizar

                    if (formulas && typeof formulas === 'object') {
                        Object.keys(formulas).forEach(id => {
                            const formula = formulas[id];
                            const li = document.createElement('li');
                            li.classList.add('list-group-item', 'mb-3', 'p-3', 'border', 'rounded');

                            li.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <div id="salvas">
                                        <strong>${formula.nome}</strong> - ${formula.desc}<br>
                                        <small>Expressão: ${formula.expressao}</small><br>
                                        <small>Categoria: ${formula.categoria}</small>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="window.calculateFormula('${id}')">
                                        Calcular
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="window.editFormula('${id}')">
                                        Editar
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="window.deleteFormula('${id}')">
                                        Excluir
                                    </button>
                                </div>
                            `;
                            list.appendChild(li);
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar fórmulas:', error);
            }
        }

        // Função para calcular a fórmula
        window.calculateFormula = async function (id) {
            try {
                const snapshot = await get(ref(database, 'formulas/' + id));
                if (snapshot.exists()) {
                    const formula = snapshot.val();
                    const originalExpression = formula.expressao;
                    let modifiedExpression = formula.expressao;

                    // Substituir os identificadores pelos valores ou deixar o identificador se o valor for inválido
                    if (formula.elementos) {
                        Object.values(formula.elementos).forEach((elemento) => {
                            const regex = new RegExp(`\\b${elemento.identificador}\\b`, 'g');
                            const valor = (elemento.valor !== null && elemento.valor !== undefined) ? elemento.valor : elemento.identificador;
                            modifiedExpression = modifiedExpression.replace(regex, valor);
                        });
                    }

                    // Verificar se a expressão é válida e pode ser calculada
                    const finalExpression = modifiedExpression.includes('=') ? modifiedExpression.split('=')[1].trim() : modifiedExpression;
                    
                    // Tentar avaliar a expressão com segurança
                    let result;
                    try {
                        result = eval(finalExpression);
                    } catch (error) {
                        console.error('Erro ao calcular a expressão:', error);
                        result = 'Erro no cálculo';
                    }

                    // Exibir o resultado
                    showCalculationResult(originalExpression, modifiedExpression, result);
                }
            } catch (error) {
                console.error('Erro ao carregar fórmula para cálculo:', error);
            }
        };

        // Função para exibir o resultado do cálculo
        function showCalculationResult(original, modified, result) {
            const resultContainer = document.getElementById('calculation-result');
            resultContainer.innerHTML = `
                <p><strong>Expressão Original:</strong> ${original}</p>
                <p><strong>Expressão Modificada:</strong> ${modified}</p>
                <p><strong>Resultado:</strong> ${result}</p>
            `;
        }

        // Função para editar a fórmula
        window.editFormula = async function (id) {
            formulaIdBeingEdited = id;
            const snapshot = await get(ref(database, 'formulas/' + id));
            if (snapshot.exists()) {
                const formula = snapshot.val();
                document.getElementById('formula-name').value = formula.nome;
                document.getElementById('formula-desc').value = formula.desc;
                document.getElementById('formula-category').value = formula.categoria;
                document.getElementById('formula-expression').value = formula.expressao;

                // Preenche os elementos na interface
                const elementosContainer = document.getElementById('elementos-container');
                elementosContainer.innerHTML = '';  // Limpa os elementos antes de adicionar
                Object.keys(formula.elementos).forEach((key, index) => {
                    const elem = formula.elementos[key];
                    const group = document.createElement('div');
                    group.className = 'input-group mb-3';
                    group.id = `elem-${index}`;
                    group.innerHTML = `
                        <div class="input-group-prepend">
                            <span class="input-group-text">Identificador</span>
                        </div>
                        <input type="text" class="form-control" value="${elem.identificador}" id="elem-${index}-id" />

                        <div class="input-group-prepend">
                            <span class="input-group-text">Descrição</span>
                        </div>
                        <input type="text" class="form-control" value="${elem.desc}" id="elem-${index}-desc" />

                        <div class="input-group-prepend">
                            <span class="input-group-text">Constante</span>
                        </div>
                        <input type="checkbox" class="form-check-input" ${elem.isConstante ? 'checked' : ''} id="elem-${index}-is-constant" />

                        <div class="input-group-prepend">
                            <span class="input-group-text">Valor</span>
                        </div>
                        <input type="number" class="form-control" value="${elem.valor}" id="elem-${index}-value" />
                        
                        <button type="button" class="btn btn-outline-danger" onclick="removeElemento('${group.id}')">
                            <i class="bi bi-x-circle"></i> Remover
                        </button>
                    `;
                    elementosContainer.appendChild(group);
                });
            }
        };

        // Função para excluir fórmula
        window.deleteFormula = async function (id) {
            if (confirm('Tem certeza que deseja excluir esta fórmula?')) {
                try {
                    await remove(ref(database, 'formulas/' + id));
                    loadFormulas();
                } catch (error) {
                    console.error('Erro ao excluir fórmula:', error);
                }
            }
        };

        // Função para resetar o formulário
        function resetForm() {
            document.getElementById('formula-name').value = '';
            document.getElementById('formula-desc').value = '';
            document.getElementById('formula-category').value = '';
            document.getElementById('formula-expression').value = '';
            document.getElementById('elementos-container').innerHTML = '';
            formulaIdBeingEdited = null;
        }

        // Adicionando o listener de clique para o botão de adicionar elemento
        document.getElementById('add-element-btn').addEventListener('click', addElemento);

        // Inicializar a lista de fórmulas
        loadFormulas();

        // Salvar a fórmula quando o botão de salvar for clicado
        document.getElementById('save-formula-btn').addEventListener('click', saveFormula);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
</body>

</html>
